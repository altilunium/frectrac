<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Altilunium Frectrac</title>
    <style>
        :root {
            --primary: #3b82f6;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #22c55e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1, h2, h3 { margin-top: 0; }

        /* Views */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Forms */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #0f172a;
            color: white;
            font-size: 16px;
        }

        button {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }

        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #334155; color: white; }

        /* Timeline List */
        .timeline-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }
        .timeline-card:hover { border-color: var(--primary); }
        .t-info h3 { margin-bottom: 5px; font-size: 1.1rem; }
        .t-info p { margin: 0; color: var(--text-muted); font-size: 0.9rem; }

        /* Detail View */
        .header-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .record-area {
            text-align: center;
            padding: 30px 0;
        }

        .big-btn {
            background: var(--primary);
            color: white;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            font-size: 1.2rem;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            border: 4px solid #60a5fa;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .big-btn span { font-size: 0.8rem; opacity: 0.8; font-weight: normal; margin-top: 5px; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-val { font-size: 1.4rem; font-weight: bold; display: block; margin-bottom: 5px; color: var(--success); }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); }

        /* Clock Viz */
        .viz-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        canvas { max-width: 100%; height: auto; }

        /* Log List */
        .log-list {
            list-style: none;
            padding: 0;
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Center align button */
            padding: 12px;
            border-bottom: 1px solid #334155;
            color: var(--text);
        }
        
        .gap-stat {
            display: block;
            font-size: 0.75rem;
            color: var(--primary);
            margin-top: 4px;
            font-weight: normal;
        }
        .gap-stat.initial {
            color: var(--text-muted);
            font-style: italic;
        }
        
        .delete-btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="view-dashboard" class="view active">
        <h1>Frequency Tracker</h1>
        
        <div class="input-group">
            <input type="text" id="newTimelineName" placeholder="Add label">
            <button class="btn-primary" onclick="addTimeline()">Add Tracker</button>
        </div>

        <div id="timelinesList">
            </div>
    </div>

    <div id="view-detail" class="view">
        <div class="header-nav">
            <button class="btn-secondary" onclick="showDashboard()">← Back</button>
            <h2 id="detailTitle" style="margin:0; flex:1;">Timeline Name</h2>
            <button class="btn-danger" onclick="deleteCurrentTimeline()">Delete</button>
        </div>

        <div class="record-area">
            <button class="big-btn" onclick="recordEvent()">
                RECORD NOW
                <span>Click to stamp</span>
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-val" id="statLastGap">-</span>
                <span class="stat-label">Since Last Event</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="statAvg">-</span>
                <span class="stat-label">Avg. Duration</span>
            </div>
        </div>

        <div class="viz-container">
            <h3 style="font-size: 1rem; color: var(--text-muted);">24h Distribution Pattern</h3>
            <canvas id="clockCanvas" width="300" height="300"></canvas>
            <p id="timeTendency" style="font-size: 0.9rem; color: var(--primary); margin-top:10px;"></p>
        </div>

        <h3 style="font-size: 1rem; margin-bottom: 10px;">History</h3>
        <ul id="eventLog" class="log-list">
            </ul>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let timelines = JSON.parse(localStorage.getItem('freqTrackerData')) || [];
    let activeTimelineId = null;

    function saveData() {
        localStorage.setItem('freqTrackerData', JSON.stringify(timelines));
    }

    // --- NAVIGATION ---
    function showDashboard() {
        document.getElementById('view-detail').classList.remove('active');
        document.getElementById('view-dashboard').classList.add('active');
        activeTimelineId = null;
        renderDashboard();
    }

    function showDetail(id) {
        activeTimelineId = id;
        document.getElementById('view-dashboard').classList.remove('active');
        document.getElementById('view-detail').classList.add('active');
        renderDetail();
    }

    // --- DASHBOARD LOGIC ---
    function addTimeline() {
        const input = document.getElementById('newTimelineName');
        const name = input.value.trim();
        if (!name) return;

        const newTimeline = {
            id: Date.now().toString(),
            name: name,
            events: [] // Stores timestamps
        };

        timelines.push(newTimeline);
        saveData();
        input.value = '';
        renderDashboard();
    }

    function renderDashboard() {
        const container = document.getElementById('timelinesList');
        container.innerHTML = '';

        if (timelines.length === 0) {
            container.innerHTML = '<p style="text-align:center; color: var(--text-muted)">No trackers yet. Create one above.</p>';
            return;
        }

        timelines.forEach(t => {
            const lastEvent = t.events.length > 0 ? new Date(t.events[0]).toLocaleString() : 'Never';
            const count = t.events.length;
            
            const div = document.createElement('div');
            div.className = 'timeline-card';
            div.onclick = () => showDetail(t.id);
            div.innerHTML = `
                <div class="t-info">
                    <h3>${t.name}</h3>
                    <p>Last: ${lastEvent}</p>
                </div>
                <div style="font-weight:bold; color: var(--primary)">${count} Records</div>
            `;
            container.appendChild(div);
        });
    }

    // --- DETAIL LOGIC ---
    function getActiveTimeline() {
        return timelines.find(t => t.id === activeTimelineId);
    }

    function deleteCurrentTimeline() {
        if(confirm("Are you sure you want to delete this tracker and all its history?")) {
            timelines = timelines.filter(t => t.id !== activeTimelineId);
            saveData();
            showDashboard();
        }
    }

    function recordEvent() {
        const t = getActiveTimeline();
        t.events.unshift(Date.now()); // Add to front
        saveData();
        renderDetail();
    }

    function deleteEvent(index) {
        if(confirm("Remove this specific entry?")) {
            const t = getActiveTimeline();
            t.events.splice(index, 1);
            saveData();
            renderDetail();
        }
    }

    // --- STATS & VIZ ---
    function formatDuration(ms) {
    if (ms < 1000) return `${ms}ms`; // Handle sub-second gaps

    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    const d = days;
    const h = hours % 24;
    const m = minutes % 60;
    const s = seconds % 60;

    const parts = [];
    if (d > 0) parts.push(`${d} day${d > 1 ? 's' : ''}`);
    if (h > 0) parts.push(`${h} hour${h > 1 ? 's' : ''}`);
    if (m > 0) parts.push(`${m} minute${m > 1 ? 's' : ''}`);
    if (s > 0 || parts.length === 0) parts.push(`${s} second${s > 1 ? 's' : ''}`);

    // Returns "X days, Y hours..." or just "Z seconds"
    return parts.join(', ');
}

    function renderDetail() {
        const t = getActiveTimeline();
        document.getElementById('detailTitle').innerText = t.name;

        // 1. Log List
        const list = document.getElementById('eventLog');
        list.innerHTML = '';
        
        t.events.forEach((ts, index) => {
            const date = new Date(ts);
            
            // Calculate Gap
            let gapHtml = '';
            if (index < t.events.length - 1) {
                const olderTs = t.events[index + 1];
                const diff = ts - olderTs;
                gapHtml = `<span class="gap-stat">↑ ${formatDuration(diff)} gap</span>`;
            } else {
                gapHtml = `<span class="gap-stat initial">First record</span>`;
            }

            const li = document.createElement('li');
            li.className = 'log-item';
            li.innerHTML = `
                <div>
                    <div style="font-weight:500">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                    ${gapHtml}
                </div>
                <button class="btn-danger delete-btn-sm" onclick="deleteEvent(${index})">X</button>
            `;
            list.appendChild(li);
        });

        // 2. Statistics
        const statLast = document.getElementById('statLastGap');
        const statAvg = document.getElementById('statAvg');
        const tendencyText = document.getElementById('timeTendency');

        if (t.events.length < 2) {
            statLast.innerText = t.events.length === 1 ? formatDuration(Date.now() - t.events[0]) : '-';
            statAvg.innerText = 'Need 2+ records';
            tendencyText.innerText = 'Not enough data for pattern analysis.';
            drawClock(t.events);
            return;
        }

        const lastGap = t.events[0] - t.events[1];
        statLast.innerText = formatDuration(Date.now() - t.events[0]);

        let totalDiff = 0;
        for (let i = 0; i < t.events.length - 1; i++) {
            totalDiff += (t.events[i] - t.events[i+1]);
        }
        const avgDiff = totalDiff / (t.events.length - 1);
        statAvg.innerText = formatDuration(avgDiff);

        // 3. Visualization
        drawClock(t.events);
        analyzeTimeTendency(t.events);
    }

    function analyzeTimeTendency(events) {
        if(events.length === 0) return;
        
        let morning = 0, afternoon = 0, evening = 0, night = 0;
        
        events.forEach(ts => {
            const hour = new Date(ts).getHours();
            if(hour >= 5 && hour < 12) morning++;
            else if(hour >= 12 && hour < 17) afternoon++;
            else if(hour >= 17 && hour < 22) evening++;
            else night++;
        });

        const max = Math.max(morning, afternoon, evening, night);
        let text = "Events usually happen in the ";
        if(max === morning) text += "Morning.";
        else if(max === afternoon) text += "Afternoon.";
        else if(max === evening) text += "Evening.";
        else text += "Night.";

        document.getElementById('timeTendency').innerText = text;
    }

    function drawClock(events) {
        const canvas = document.getElementById('clockCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        const cx = w/2;
        const cy = h/2;
        const r = (w/2) - 20;

        // Clear
        ctx.clearRect(0, 0, w, h);

        // Draw Clock Face
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, 2 * Math.PI);
        ctx.strokeStyle = '#334155';
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = '10px Arial';
        ctx.fillStyle = '#94a3b8';

        for(let i=0; i<24; i+=6) {
            const angle = (i * 15 - 90) * (Math.PI / 180); 
            const tx = cx + (r - 15) * Math.cos(angle);
            const ty = cy + (r - 15) * Math.sin(angle);
            ctx.fillText(i + 'h', tx, ty);
        }

        events.forEach((ts, index) => {
            const date = new Date(ts);
            const hours = date.getHours();
            const mins = date.getMinutes();
            const totalMinutes = (hours * 60) + mins;
            
            const angle = ((totalMinutes / 1440) * 360 - 90) * (Math.PI / 180);

            const px = cx + r * Math.cos(angle);
            const py = cy + r * Math.sin(angle);

            ctx.beginPath();
            ctx.arc(px, py, 6, 0, 2 * Math.PI);
            
            if(index === 0) {
                ctx.fillStyle = '#ef4444'; 
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#ef4444';
            } else {
                ctx.fillStyle = '#3b82f6';
                ctx.shadowBlur = 0;
            }
            ctx.fill();
        });
        
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#fff';
        ctx.fillText("24h View", cx, cy);
    }

    // Init
    renderDashboard();

</script>

</body>
</html>
